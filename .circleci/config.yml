version: 2.1

# Docker image with Verilator pre-installed
orbs:
  docker: circleci/docker@2.2.0

jobs:
  # Job 1: Verilator Lint Check
  verilator-lint:
    docker:
      - image: verilator/verilator:latest
    steps:
      - checkout
      - run:
          name: "Verilator Version"
          command: verilator --version
      - run:
          name: "Lint SystemVerilog Files"
          command: |
            echo "Running Verilator lint on all .sv/.svh files..."
            find . -name "*.sv" -o -name "*.svh" | while read file; do
              echo "Linting: $file"
              verilator --lint-only -Wall -Wno-fatal --bbox-unsup "$file" || true
            done
      - run:
          name: "Check for Critical Errors"
          command: |
            ERROR_COUNT=$(find . -name "*.sv" -o -name "*.svh" | while read file; do
              verilator --lint-only -Wall "$file" 2>&1 | grep -c "Error:" || true
            done | awk '{s+=$1} END {print s}')
            echo "Total errors found: $ERROR_COUNT"
            if [ "$ERROR_COUNT" -gt 0 ]; then
              echo "❌ Verilator found $ERROR_COUNT errors"
              exit 1
            else
              echo "✅ No critical errors found"
            fi

  # Job 2: AXI4 VIP Compilation Check (Questa)
  compile-axi4-questa:
    docker:
      - image: cimg/base:stable
    steps:
      - checkout
      - run:
          name: "Skip Questa Compilation (Simulator Not Available)"
          command: |
            echo "⚠️  Questa simulator not available in CI environment"
            echo "✅ Skipping compilation check (manual verification required)"
      # Uncomment if you have a Questa Docker image or license server
      # - run:
      #     name: "Compile AXI4 VIP with Questa"
      #     command: |
      #       cd axi4/examples
      #       make compile_questa

  # Job 3: Documentation Build Check
  build-docs:
    docker:
      - image: cimg/ruby:3.1
    steps:
      - checkout
      - run:
          name: "Install Jekyll Dependencies"
          command: |
            gem install bundler
            bundle install
      - run:
          name: "Build Jekyll Site"
          command: |
            bundle exec jekyll build
      - run:
          name: "Check for Build Errors"
          command: |
            if [ -d "_site" ]; then
              echo "✅ Jekyll site built successfully"
              ls -lh _site/
            else
              echo "❌ Jekyll build failed"
              exit 1
            fi

workflows:
  version: 2
  lint-and-build:
    jobs:
      - verilator-lint
      - compile-axi4-questa:
          requires:
            - verilator-lint
      - build-docs:
          requires:
            - verilator-lint
