version: 2.1

# Docker image with Verilator pre-installed
orbs:
  docker: circleci/docker@2.2.0

jobs:
  # Job 1: Verilator Lint Check
  verilator-lint:
    docker:
      - image: verilator/verilator:v5.026
    steps:
      - checkout
      - run:
          name: "Verilator Version"
          command: verilator --version
      - run:
          name: "Lint Portable Subset"
          command: |
            # Verilator does not fully support UVM; lint a portable subset (types/IF/assertions).
            verilator --lint-only --sv -Wall -Wno-fatal -Wno-DECLFILENAME --bbox-unsup \
              -Icommon/sv \
              -Iaxi4/sv/pkg \
              -Iaxi4/sv/if \
              -Iaxi4/sv/assertions \
              axi4/sv/pkg/axi4_types_pkg.sv \
              axi4/sv/if/axi4_if.sv \
              axi4/sv/assertions/axi4_assertions.sv

  # Job 2: AXI4 VIP Compilation Check (Questa)
  compile-axi4-questa:
    docker:
      - image: cimg/base:stable
    steps:
      - checkout
      - run:
          name: "Skip Questa Compilation (Simulator Not Available)"
          command: |
            echo "⚠️  Questa simulator not available in CI environment"
            echo "✅ Skipping compilation check (manual verification required)"
      # Uncomment if you have a Questa Docker image or license server
      # - run:
      #     name: "Compile AXI4 VIP with Questa"
      #     command: |
      #       cd axi4/examples
      #       make compile_questa

  # Job 3: Documentation Build Check
  build-docs:
    docker:
      - image: cimg/ruby:3.1
    steps:
      - checkout
      - run:
          name: "Install Jekyll Dependencies"
          command: |
            gem install bundler
            bundle install
      - run:
          name: "Build Jekyll Site"
          command: |
            bundle exec jekyll build
      - run:
          name: "Check for Build Errors"
          command: |
            if [ -d "_site" ]; then
              echo "✅ Jekyll site built successfully"
              ls -lh _site/
            else
              echo "❌ Jekyll build failed"
              exit 1
            fi

workflows:
  version: 2
  lint-and-build:
    jobs:
      - verilator-lint
      - compile-axi4-questa:
          requires:
            - verilator-lint
      - build-docs:
          requires:
            - verilator-lint
